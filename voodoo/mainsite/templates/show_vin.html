{% extends "base.html" %}

{% block css %}
<style>
</style>
{% endblock %}
{% block javascript %}
<script type="text/javascript"> 
	$(function(){
		var details_count = 0;
		var offered_details_count = 0;
		var vin_id = -1
		$('a.vin_link').live('click',function (event) {
			vin_id = $(this).attr('href')
			console.log("show vin "+vin_id)
			$.ajax({
                  type: "POST",
                  url: '/get_vin_by_id/',
                  data: {"vin_id":vin_id}
                  }).done(function( msg ) {
                  	details_count = 0
                  	offered_details_count = 0
                  	$("#vin_info").html('<p>Содержимое VIN-запроса №__ (импортирован в ОЦ, заказ №__)</p>'
                  		+ '<table>'
	                  		+ '<tr>'
		                  		+ '<td>Марка автомобиля</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_brand +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>VIN</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_vin +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>Модель серия</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_model +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>Двигатель</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_engine +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>Год выпуска</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_year +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>Объем двигателя</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.engine_capacity +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>Кузов</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_body +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>КПП</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_kpp +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>Дополнительно</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.car_additionals +'</td>'
	                  		+ '</tr>'
	                  		+ '<tr>'
		                  		+ '<td>Дополнительная информация</td>'
		                  		+ '<td>'+ msg["vin_request"][0].fields.additional_info +'</td>'
	                  		+ '<tr>'
                  		+ '</table>'
                  		+ '<p>Заказываемые Вами запчасти</p>'
						+ '<table id="vin_details">'
							+ '<thead>'
								+ '<tr>'
									+ '<td>№</td>'
									+ '<td>Описание</td>'
									+ '<td>Кол.</td>'
								+ '</tr>'
							+ '</thead>'
                  		+ '</table>'                  		
                  		);

					$.each(msg["vin_details"],function(index, value) {
						$("#vin_details").append(
							  '<tr>'
								+ '<td>'+ ++details_count +'</td>'
								+ '<td><input type="text" class="detail_name" value="'+ msg["vin_details"][index].fields.name +'"></td>'
								+ '<td><input type="text" class="detail_number" value="'+ msg["vin_details"][index].fields.number +'"></td><td><label class="error_label"></label></td>'
							+ '</tr>')
					})
					$("#vin_info").append(
					'<input type="button" value="Добавить строку" id="add_to_details"></input>'
					+'<input type="button" id="delete_details" value="Удалить строку"></input>'
					+'<input type="button" id="save_details" value="Сохранить"></input>'
					)
					$("#vin_info").append(
						'<p>Предлагаемые вам запчасти</p>'
						+ '<table id="offered_details">'
							+ '<thead>'
								+ '<tr>'
									+ '<td>№</td>'
									+ '<td>Бренд</td>'
									+ '<td>Описание</td>'
									+ '<td>Цена</td>'
									+ '<td>Кол.</td>'
									+ '<td>Срок поставки</td>'
									+ '<td>Статус</td>'
								+ '</tr>'
							+ '</thead>'
                  		+ '</table>'     
					)

					$.each(msg["vin_details"],function(index, value) {
						$("#offered_details").append(
							  '<tr>'
								+ '<td>'+ ++offered_details_count +'</td>'
								+ '<td>'+ msg["vin_details"][index].fields.name + '</td>'
								+ '<td>'+ msg["vin_details"][index].fields.name + '</td>'
								+ '<td>'+ msg["vin_details"][index].fields.name + '</td>'
								+ '<td><input class="num_offered_detail" type="text" value="'+ msg["vin_details"][index].fields.name + '"></td>'
								+ '<td>'+ msg["vin_details"][index].fields.name + '</td>'
								+ '<td><input type="checkbox" checked></td>'
							+ '</tr>')
					})

					$("#vin_info").append(
					'<input type="button" value="Оформить заказ" id="order_details"></input>'
					)

                  })
			event.preventDefault();
		})

		$('#add_to_details').live('click',function () {
			$("#vin_details").append
			(
				  '<tr>'
				+ '<td>'+ ++details_count +'</td>'
				+ '<td><input type="text" class="detail_name"></td>'
				+ '<td><input type="text" class="detail_number"></td><td><label class="error_label"></label></td>'
				+ '</tr>'
			);
		});

		$('#delete_details').live('click',function () {
			$('#vin_details tbody tr:last').remove();
			if($('#vin_details tbody tr:last').length > 0){
				details_count--;
			}
			if($('#vin_details tbody tr:last').length == 0){
				details_count=0
			}
		});

		$('#save_details').live('click',function () {
				var details_name = Array()
				var details_number = Array()
				var can_request = true
				$("#vin_details tbody tr").each(function() {
					if($('.detail_name',this).val()==""){
						$('.error_label', this).text('Необходимо заполнить описание')
						can_request = false
					}
					else{
						$('.error_label', this).text('')
						details_name.push($('.detail_name',this).val())	
					}

					if($('.detail_number',this).val()==""){
						if($('.error_label', this).text()==""){
							$('.error_label', this).text('Необходимо заполнить колличество деталей')
						}else{
							$('.error_label', this).text('Необходимо заполнить описание и колличество деталей')
						}
						can_request = false
					}
					else{
						if($('.error_label', this).text()==""){
							$('.error_label', this).text('')	
						}
						var intRegex = /^\d+$/;
						if(!intRegex.test($('.detail_number',this).val())){
							$('.error_label', this).text('Пожалуйства используйте только цифры для колличества деталей.')		
							can_request = false
						}
						details_number.push($('.detail_number',this).val())	
					}
				    
				});
				if(can_request){
					$.ajax({
	                  type: "POST",
	                  url: '/save_del_details/',
	                  data: {"details_name":details_name, "details_number":details_number, "vin_id": vin_id}
	                  }).done(function( msg ) {

	                  })
              }
		});

		$('#order_details').live('click',function () {
			$("#offered_details .num_offered_detail").each(function() {
				console.log($(this).val())
			})
			$.ajax({
              type: "POST",
              url: '/order_details/',
              data: {"vin_id": vin_id}
              }).done(function( msg ) {

              })
		});

	})

</script>
{% endblock %}

{% block main %}
<h3>Фильтр по VIN запросам...</h3>

<form style="border: 1px solid black; border-radius: 6px;" action="/show_vin/" method="post">
			<!-- <div style="padding-left:100px;">{{ form.min_date.errors }}</div> -->
            <pre style="margin: 10px 10px;">Создана/редактирована между  {{ form.min_date }}    и     {{form.max_date}}</pre>
	<input style="margin: 10px 0 10px 240px;" type="submit" value="Применить фильтр" />
</form>

{% if result %}
<table>
	<thead>
		<tr>
			<td>Номер №</td>
			<td>Дата запроса</td>
			<td>VIN</td>
			<td>Комментарии</td>
			<td>Статус</td>
		</tr>
	</thead>
	<tbody>
		{% for row in result %}
		
			<tr>
			  <td>{{ row.id }}</td>
			  <td>{{ row.date }}</td>
			  <td><a class="vin_link" href="{{row.id}}">{{ row.car_vin }}</a></td>
			  <td>{{ row.comments }}</td>
			  <td>
			  	{% if row.status == 'Принят' %}
			  		Обрабатывается
			  	{% else %}
			  		Обработан
			  	{% endif %}
			  </td>
			</tr>
		{% endfor %}
	</tbody>
</table>

<div id="vin_info">
</div>


{% else %}
<h3>{{error}}</h3>
{% endif %}

{% endblock %}